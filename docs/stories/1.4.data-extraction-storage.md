# Story 1.4: Data Extraction & Storage

## Status
Draft

## Story
**As a** System,
**I want** To parse the raw post body to extract key tournament details,
**so that** The unstructured data is converted into a structured format.

## Acceptance Criteria
1. The parser logic can extract key fields (Title, Rank Range, etc.) from a typical forum post.
2. For common URL types (Google Sheets, osu! forums, Google Forms, Challonge, YouTube, Twitch), the parser extracts and stores **only the unique ID or slug** from the URL, not the entire string.
3. If a field cannot be found, its value is stored as NULL in the database.
4. The extracted data is saved as a new row in the `tournaments` table with a status of "pending_review".

## Tasks / Subtasks

- [ ] Create Forum Post Pattern Parser (AC: 1)
  - [ ] Create `src/Services/ForumPostParserService.php` for content parsing
  - [ ] Implement tournament title extraction patterns (English and Korean)
  - [ ] Implement rank range pattern matching (`[0-9]K+` or `Open` formats)
  - [ ] Implement tournament date extraction patterns
  - [ ] Implement host name extraction from post signatures

- [ ] Build URL ID Extraction System (AC: 2)
  - [ ] Create `src/Utils/UrlExtractor.php` for URL parsing utilities
  - [ ] Implement Google Sheets ID extraction (`/d/([a-zA-Z0-9-_]+)/`)
  - [ ] Implement osu! forum link ID extraction (`/([0-9]+)` pattern)
  - [ ] Implement Google Forms ID extraction (`/forms/d/([a-zA-Z0-9-_]+)/`)
  - [ ] Implement Challonge tournament slug extraction
  - [ ] Implement YouTube video ID extraction
  - [ ] Implement Twitch stream slug extraction

- [ ] Implement Tournament Data Model Extensions (AC: 3, 4)
  - [ ] Extend `src/Models/Tournament.php` with parsing methods
  - [ ] Add `extractAndSaveFromRawData()` method for complete parsing workflow
  - [ ] Implement field validation with NULL fallbacks for failed extractions
  - [ ] Add tournament status management (`pending_review` default)

- [ ] Create Complete Parser Integration (AC: 1, 2, 3, 4)
  - [ ] Update `scripts/parser/basic_parser.php` to include data extraction
  - [ ] Integrate ForumPostParserService into parser workflow
  - [ ] Implement URL extraction and validation pipeline
  - [ ] Add comprehensive error logging for failed parsing attempts
  - [ ] Ensure extracted data saves with `pending_review` status

- [ ] Add Data Validation and Sanitization (Security)
  - [ ] Implement input validation for extracted data
  - [ ] Sanitize Korean characters and special symbols
  - [ ] Validate URL extractions before database storage
  - [ ] Add data type validation for numeric fields (rank ranges, IDs)

- [ ] Create Unit Tests for Parser Components (Testing)
  - [ ] Create `tests/Unit/Services/ForumPostParserServiceTest.php`
  - [ ] Create `tests/Unit/Utils/UrlExtractorTest.php`
  - [ ] Test pattern matching with real forum post samples
  - [ ] Test NULL handling for failed extractions
  - [ ] Test Korean character processing

## Dev Notes

### Previous Story Context
[Source: 1.3.basic-parser-script.md#dev-agent-record]

From Story 1.3 implementation (QA Approved - Quality Score: 85/100):
- ✅ OAuth client credentials authentication system fully operational
- ✅ Database schema ready with tournaments table structure
- ✅ Forum topic fetching successfully implemented via `OsuForumService`
- ✅ Tournament model with parser-specific methods available
- ✅ Korean timezone support implemented and tested
- ✅ **RESOLVED**: OAuth integration now fully functional - parser connects to osu! API successfully
- ✅ **VERIFIED**: API rate limiting and error handling working correctly
- ✅ **CONFIRMED**: Parser processed 50 forum topics without errors in QA testing

**Foundation Ready**: Story 1.3 provides a stable, tested foundation for data extraction. Parser can successfully fetch forum post content and save basic tournament data to the database.

### Database Schema Integration
[Source: docs/architecture/tech-stack.md#database-schema-sqlite-app-platform-storage]

**Tournaments Table Structure** (already exists from Story 1.1):
```sql
CREATE TABLE tournaments (
    tournament_id INTEGER PRIMARY KEY AUTOINCREMENT,
    topic_id INTEGER UNIQUE NOT NULL,    -- Already populated by Story 1.3
    title TEXT NOT NULL,                 -- RAW title to be processed by this story
    host_name TEXT,                      -- EXTRACT from post content/signature
    game_mode TEXT DEFAULT 'osu',        -- Standard tournament forum = osu mode
    banner_url TEXT,                     -- EXTRACT image URLs from post content
    sheet_id TEXT,                       -- EXTRACT Google Sheets ID only
    discord_id TEXT,                     -- EXTRACT Discord server ID/invite
    forum_link TEXT,                     -- Already set by Story 1.3
    stream_url TEXT,                     -- EXTRACT Twitch/YouTube slug only
    registration_url TEXT,               -- EXTRACT Google Forms ID only
    has_badge BOOLEAN DEFAULT 0,         -- EXTRACT badge status from post
    rank_range TEXT,                     -- EXTRACT rank restrictions (0K+, Open, etc.)
    tournament_dates TEXT,               -- EXTRACT date ranges from content
    tournament_status TEXT DEFAULT 'pending_review',  -- Set by this story
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Key Parsing Rules**:
- **Title Processing**: Clean raw forum title, remove prefixes like "[Tournament]" or "[TWC]"
- **URL ID Extraction**: Store ONLY unique identifiers, not full URLs
- **NULL Handling**: If extraction fails, field remains NULL for admin review
- **Status Setting**: All parsed tournaments get `tournament_status = 'pending_review'`

### Forum Post Pattern Analysis
[Source: docs/architecture/tech-stack.md#external-apis-services]

**osu! Standard Tournament Forum Post Structure**:
```
[Tournament Title] - [Rank Range] - [Badge Status]

**Tournament Information:**
Host: [Host Name]
Date: [Start Date] - [End Date]
Format: [Tournament Format]
Rank Range: [0-9]+K+ or Open
Prize: [Prize Information]
Badge: Yes/No

**Links:**
Registration: [Google Forms Link]
Spreadsheet: [Google Sheets Link]  
Discord: [Discord Invite]
Stream: [Twitch/YouTube Link]

[Additional tournament details...]

**Tournament Structure:**
[Bracket information, rules, etc.]
```

**Pattern Matching Requirements**:
- **Title**: Extract from forum topic title and first header line
- **Rank Range**: Match patterns like `0K+`, `100K+`, `Open`, `#1000-#5000`
- **URLs**: Extract IDs using regex patterns for each service type
- **Host**: Usually found after "Host:" label or in signature
- **Dates**: Various formats including Korean date formats

### File Location Specifications
[Source: docs/architecture/unified-project-structure.md#greenfield-design]

**Parser Enhancement Components**:
- **Forum Parser Service**: `src/Services/ForumPostParserService.php` - Content parsing logic
- **URL Extraction Utility**: `src/Utils/UrlExtractor.php` - URL ID extraction patterns
- **Tournament Model**: Extend existing `src/Models/Tournament.php` - Add parsing methods
- **Parser Script**: Update existing `scripts/parser/basic_parser.php` - Integrate parsing
- **Unit Tests**: `tests/Unit/Services/ForumPostParserServiceTest.php`, `tests/Unit/Utils/UrlExtractorTest.php`

### URL Extraction Patterns
[Source: docs/architecture/tech-stack.md#external-apis-services]

**URL ID Extraction Patterns**:
```php
// Google Sheets: Extract document ID
'sheets.google.com/.*?/d/([a-zA-Z0-9-_]+)' -> store $1

// Google Forms: Extract form ID
'forms.google.com/.*?/d/([a-zA-Z0-9-_]+)' -> store $1

// osu! Forum: Extract topic ID
'osu.ppy.sh/community/forums/topics/([0-9]+)' -> store $1

// Challonge: Extract tournament slug
'challonge.com/([a-zA-Z0-9_-]+)' -> store $1

// YouTube: Extract video ID
'youtube.com/watch\?v=([a-zA-Z0-9_-]+)' -> store $1
'youtu.be/([a-zA-Z0-9_-]+)' -> store $1

// Twitch: Extract stream slug
'twitch.tv/([a-zA-Z0-9_]+)' -> store $1
```

### Security Requirements
[Source: docs/architecture/coding-standards.md#security-requirements]

**NON-NEGOTIABLE Security Implementation**:
- **Input Validation**: All extracted data must be validated using `filter_var()` functions
- **SQL Protection**: All database updates use prepared statements (already established)
- **XSS Prevention**: Extracted content must be sanitized before storage
- **Korean Character Safety**: Proper UTF-8 validation for Korean tournament content
- **URL Validation**: Extracted URLs must be validated before ID extraction

**Security Implementation Pattern**:
```php
// Validate extracted tournament title
$title = filter_var(trim($extractedTitle), FILTER_SANITIZE_STRING);
if (strlen($title) < 3 || strlen($title) > 200) {
    $title = null; // Mark for admin review
}

// Validate extracted rank range
$rankRange = filter_var($extractedRankRange, FILTER_SANITIZE_STRING);
if (!preg_match('/^(Open|\d+K?\+?|#\d+-#?\d*)$/', $rankRange)) {
    $rankRange = null; // Invalid format, mark for review
}

// Safe URL ID extraction
$sheetId = $this->extractGoogleSheetsId($url);
if ($sheetId && !preg_match('/^[a-zA-Z0-9_-]{28,}$/', $sheetId)) {
    $sheetId = null; // Invalid format
}
```

### Korean Content Handling
[Source: docs/architecture/tech-stack.md#korean-localization-stack]

**Korean Tournament Processing**:
- **Character Encoding**: UTF-8 support for Korean tournament titles and content
- **Pattern Matching**: Support Korean date formats and tournament terminology
- **Rank Range**: Handle Korean rank expressions (`오픈`, `제한없음`)
- **Host Names**: Extract Korean usernames and team names properly

### Testing Requirements
[Source: docs/architecture/coding-standards.md#testing-standards]

**Parser Testing Strategy**:
- **Unit Tests**: Test individual parsing methods with sample forum posts
- **Pattern Tests**: Verify regex patterns with real tournament post examples
- **Edge Case Tests**: Handle malformed posts, missing fields, invalid URLs
- **Korean Content Tests**: Test Korean character extraction and validation
- **Integration Tests**: Full parsing workflow with database storage

**Test Files Location**:
- `tests/Unit/Services/ForumPostParserServiceTest.php` - Parser service unit tests
- `tests/Unit/Utils/UrlExtractorTest.php` - URL extraction utility tests
- `tests/Integration/DataExtractionIntegrationTest.php` - Complete parsing workflow

### Performance Considerations
[Source: docs/architecture/coding-standards.md#performance-standards]

**Parsing Optimization**:
- **Pattern Caching**: Cache compiled regex patterns for repeated use
- **Batch Processing**: Process multiple posts efficiently in parser script
- **Database Transactions**: Group related updates for consistency
- **Memory Management**: Clear large post content after processing

### Error Handling Strategy
[Source: docs/architecture/coding-standards.md#error-handling]

**Parser Error Handling**:
```php
// Graceful extraction failure handling
try {
    $extractedData = $this->parseForumPost($postContent);
} catch (PatternMatchException $e) {
    // Log parsing failure, continue with NULL values
    error_log("Pattern matching failed for topic_id {$topicId}: " . $e->getMessage());
    $extractedData = $this->getDefaultNullData();
}

// Individual field extraction with fallbacks
$title = $this->extractTitle($content) ?? $this->fallbackTitleFromTopicTitle($rawTitle);
$rankRange = $this->extractRankRange($content) ?? null; // Admin review required
```

### Testing
**Testing Requirements** from Architecture:
- **Test Framework**: PHPUnit (established in Story 1.3)
- **Test File Locations**: 
  - `tests/Unit/Services/ForumPostParserServiceTest.php`
  - `tests/Unit/Utils/UrlExtractorTest.php`
- **Coverage Requirements**: All parsing methods and URL extraction patterns
- **Korean Content Testing**: Test Korean character handling and pattern matching
- **Integration Testing**: Complete parsing workflow with database operations
- **Error Handling Tests**: Verify graceful failures and NULL handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-06 | 1.0 | Initial story creation with forum post parsing requirements | Bob (Scrum Master) |
| 2025-09-06 | 1.1 | Updated Previous Story Context - Story 1.3 OAuth integration resolved, foundation ready for data extraction | Bob (Scrum Master) |