# Story 1.3: Basic Parser Script

## Status
Draft

## Story
**As a** System,
**I want** A script that can fetch the latest topics from the osu! Standard tournament forum API,
**so that** I have the raw data needed for processing.

## Acceptance Criteria
1. A PHP script exists that can be executed.
2. The script successfully calls the osu! API and retrieves a list of topics.
3. Before processing, the script checks if a topic's ID already exists in the `tournaments` table and skips it if it does.
4. The raw title and post body of new, unique topics are saved for the next step.

## Tasks / Subtasks

- [ ] Create osu! API Service Integration (AC: 2)
  - [ ] Create `src/config/OsuApi.php` with osu! Forum API configuration
  - [ ] Add API client credentials environment variables to `.env.example`
  - [ ] Configure API rate limiting (300/min for Forum API as per tech stack)
  - [ ] Add Korean timezone handling for API response timestamps

- [ ] Implement Forum API Client (AC: 2)
  - [ ] Create `src/services/OsuForumService.php` for forum topic retrieval
  - [ ] Implement OAuth 2.0 client credentials flow for API authentication
  - [ ] Implement forum topics list endpoint integration
  - [ ] Add error handling for API rate limits and network failures
  - [ ] Implement secure API token handling (no logging, memory clearing)

- [ ] Create Tournament Model Extensions (AC: 3, 4)
  - [ ] Extend `src/models/Tournament.php` with parser-specific methods
  - [ ] Implement `findByTopicId()` method for duplicate checking
  - [ ] Add `createFromForumPost()` method for raw data storage
  - [ ] Implement data validation for forum post structure

- [ ] Build Parser Script (AC: 1, 3, 4)
  - [ ] Create `scripts/parser/basic_parser.php` as executable script
  - [ ] Implement topic ID duplicate checking logic
  - [ ] Implement raw title and post body extraction
  - [ ] Save new topics to tournaments table with `pending_review` status
  - [ ] Add comprehensive error logging to system_logs table

- [ ] Implement Data Storage Logic (AC: 4)
  - [ ] Create database insertion methods for raw forum data
  - [ ] Store topic_id, title, raw post body for processing pipeline
  - [ ] Set tournament_status to 'pending_review' for new entries
  - [ ] Add created_at timestamp with Korean timezone (Asia/Seoul)

- [ ] Create Parser Configuration (Deployment)
  - [ ] Add parser script environment variables to `.do/app.yaml`
  - [ ] Configure App Platform scheduled job for future automation
  - [ ] Set proper permissions for script execution
  - [ ] Add health check endpoint for parser service

- [ ] Add Unit Tests for Parser Components (Testing)
  - [ ] Create `tests/unit/Services/OsuForumServiceTest.php`
  - [ ] Create `tests/unit/Models/TournamentParserTest.php`
  - [ ] Test API authentication, rate limiting, and error handling
  - [ ] Test duplicate detection logic with mock data
  - [ ] Test Korean timezone handling and data storage

## Dev Notes

### Previous Story Context
[Source: 1.2.admin-login.md#dev-agent-record]

From Story 1.2 implementation:
- ✅ OAuth 2.0 authentication system established with secure token handling
- ✅ Database schema ready with tournaments table structure
- ✅ Security framework implemented (CSRF protection, prepared statements, input validation)
- ✅ Korean timezone (Asia/Seoul) configuration working
- ✅ PSR-4 autoloading and project structure established
- ✅ Environment variable loading system (`EnvLoader.php`) ready for API configuration
- ✅ App Platform deployment configuration (.do/app.yaml) ready for service extensions

### osu! API Integration Architecture
[Source: docs/architecture/tech-stack.md#external-apis-services]

**osu! Forum API Integration:**
- **Authentication Method**: OAuth 2.0 client credentials flow (different from user authentication)
- **Rate Limits**: 300/min for Forum API (stricter than general API 1000/min)
- **Forum Endpoints**: 
  - Topics List: `https://osu.ppy.sh/api/v2/forums/55/topics` (Standard tournament forum)
  - Authentication: `https://osu.ppy.sh/oauth/token` (client credentials grant)
- **Required Scopes**: `public` scope for forum data access
- **Response Format**: JSON with topic metadata and post content

### Database Schema Integration
[Source: docs/stories/1.1.project-database-setup.md#database-schema-details]

**Tournaments Table Structure** (already exists from Story 1.1):
```sql
CREATE TABLE tournaments (
    tournament_id INTEGER PRIMARY KEY AUTOINCREMENT,
    topic_id INTEGER UNIQUE NOT NULL,    -- osu! forum topic ID (for duplicate checking)
    title TEXT NOT NULL,                 -- Raw tournament title from forum post
    host_name TEXT,                      -- To be parsed in future stories
    game_mode TEXT DEFAULT 'osu',        -- Standard tournament forum = osu mode
    banner_url TEXT,                     -- To be parsed in future stories  
    sheet_id TEXT,                       -- To be parsed in future stories
    discord_id TEXT,                     -- To be parsed in future stories
    forum_link TEXT,                     -- Direct forum topic link
    stream_url TEXT,                     -- To be parsed in future stories
    registration_url TEXT,               -- To be parsed in future stories
    has_badge BOOLEAN DEFAULT 0,         -- To be parsed in future stories
    rank_range TEXT,                     -- To be parsed in future stories
    tournament_dates TEXT,               -- To be parsed in future stories
    tournament_status TEXT DEFAULT 'pending_review',  -- New entries start here
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**System Logs Table Structure** (already exists from Story 1.1):
```sql
CREATE TABLE system_logs (
    log_id INTEGER PRIMARY KEY AUTOINCREMENT,
    log_level TEXT NOT NULL,        -- ERROR, WARNING, INFO for parser logging
    message TEXT NOT NULL,          -- Parser status and error messages
    context TEXT,                   -- JSON context (topic_id, API response status, etc.)
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### File Location Specifications
[Source: docs/architecture/source-tree.md#target-implementation-structure]

**Parser Components:**
- **API Config**: `src/config/OsuApi.php` - Forum API client credentials and endpoints
- **Forum Service**: `src/services/OsuForumService.php` - API integration and authentication
- **Tournament Model**: `src/models/Tournament.php` - Extend existing model with parser methods
- **Parser Script**: `scripts/parser/basic_parser.php` - Executable command-line script
- **Environment Config**: Add to existing `.env.example` - API credentials configuration

### Security Requirements
[Source: docs/architecture/coding-standards.md#security-requirements]

**NON-NEGOTIABLE Security Implementation:**
- **API Token Security**: OAuth client credentials tokens must never be logged and cleared from memory after use
- **Input Validation**: All API response data must be validated using `filter_var()` functions
- **SQL Protection**: All database queries must use prepared statements (PDO) - already established
- **Rate Limit Compliance**: Must respect 300/min Forum API limits with proper backoff
- **Error Handling**: API errors must not expose internal system details in logs
- **JSON Validation**: Forum API responses must be properly validated before processing

**Security Implementation Pattern:**
```php
// SEC-001 FIX: Enhanced OAuth client credentials flow with secure memory management
class OsuForumService {
    private $lastApiCall = 0;
    private $rateLimitDelay = 250; // Conservative 250ms delay (240/min vs 300/min limit)
    private $maxRetries = 3;
    
    public function authenticateClient(): array {
        // Load credentials securely without logging
        $clientId = $_ENV['OSU_FORUM_CLIENT_ID'] ?? throw new ConfigException('Missing client ID');
        $clientSecret = $_ENV['OSU_FORUM_CLIENT_SECRET'] ?? throw new ConfigException('Missing client secret');
        
        $tokenData = $this->requestClientCredentialsToken($clientId, $clientSecret);
        
        // SEC-001: Immediately clear credentials from memory
        sodium_memzero($clientId);
        sodium_memzero($clientSecret);
        
        if (!isset($tokenData['access_token'])) {
            throw new AuthenticationException('Failed to obtain access token');
        }
        
        return $tokenData;
    }
    
    // SEC-002 FIX: Rate limiting with exponential backoff
    private function makeSecureApiRequest(string $endpoint, string $token): array {
        $attempt = 0;
        
        while ($attempt < $this->maxRetries) {
            // Enforce rate limiting
            $timeSinceLastCall = (microtime(true) * 1000) - $this->lastApiCall;
            if ($timeSinceLastCall < $this->rateLimitDelay) {
                usleep(($this->rateLimitDelay - $timeSinceLastCall) * 1000);
            }
            
            $this->lastApiCall = microtime(true) * 1000;
            
            try {
                $response = $this->performApiRequest($endpoint, $token);
                
                // Success - clear token from memory and return
                sodium_memzero($token);
                return $response;
                
            } catch (RateLimitException $e) {
                $attempt++;
                // SEC-002: Exponential backoff for rate limit violations
                $backoffDelay = pow(2, $attempt) * 1000; // 2s, 4s, 8s
                error_log("Rate limit hit, backing off for {$backoffDelay}ms");
                usleep($backoffDelay * 1000);
            } catch (NetworkException $e) {
                // TECH-001: Network failure recovery
                $attempt++;
                if ($attempt >= $this->maxRetries) {
                    sodium_memzero($token);
                    throw new ServiceException("API request failed after {$this->maxRetries} attempts");
                }
                usleep(1000000); // 1 second delay before retry
            }
        }
        
        // Clear token before throwing exception
        sodium_memzero($token);
        throw new ServiceException('Max retry attempts exceeded');
    }
    
    // TECH-001 FIX: OAuth authentication failure recovery
    public function getTopicsWithRetry(): array {
        $maxAuthRetries = 2;
        $authAttempt = 0;
        
        while ($authAttempt < $maxAuthRetries) {
            try {
                $tokenData = $this->authenticateClient();
                $accessToken = $tokenData['access_token'];
                
                $response = $this->makeSecureApiRequest('/forums/55/topics', $accessToken);
                
                // Success - clear all sensitive data
                if (isset($tokenData)) {
                    array_walk_recursive($tokenData, function(&$item) {
                        if (is_string($item)) sodium_memzero($item);
                    });
                    unset($tokenData);
                }
                
                return $response;
                
            } catch (AuthenticationException $e) {
                $authAttempt++;
                error_log("OAuth authentication failed (attempt {$authAttempt}): " . $e->getMessage());
                
                if ($authAttempt >= $maxAuthRetries) {
                    throw new ServiceException('OAuth authentication failed after multiple attempts');
                }
                
                // Wait before retry
                sleep(5);
            }
        }
        
        throw new ServiceException('Failed to authenticate after maximum retries');
    }
}

// Enhanced validation and sanitization
$topicId = filter_var($response['id'], FILTER_VALIDATE_INT);
if (!$topicId) {
    throw new ValidationException('Invalid topic ID from API response');
}

// Safe database insertion with transaction
$this->db->beginTransaction();
try {
    $stmt = $this->db->prepare("INSERT INTO tournaments (topic_id, title, forum_link, tournament_status) VALUES (?, ?, ?, ?)");
    $stmt->execute([$topicId, $sanitizedTitle, $forumLink, 'pending_review']);
    $this->db->commit();
} catch (Exception $e) {
    $this->db->rollback();
    throw new DatabaseException('Failed to save tournament: ' . $e->getMessage());
}
```

### Korean Deployment Considerations
[Source: docs/architecture/tech-stack.md#korean-localization-stack]

**Korean Market Integration:**
- **Timezone**: All API response timestamps converted to Asia/Seoul timezone
- **Character Encoding**: UTF-8 support for Korean tournament titles and content
- **Forum Content**: Support both Korean and English tournament announcements
- **App Platform**: Script ready for scheduled job deployment in Singapore (SGP1)

### Technology Stack Integration
[Source: docs/architecture/tech-stack.md#planned-technology-stack]

**Implementation Stack:**
- **Backend**: Vanilla PHP 8.1+ with existing PSR-4 autoloading
- **API Integration**: Native PHP cURL for osu! Forum API (consistent with OAuth implementation)
- **Database**: Existing SQLite with prepared statements via PDO
- **Logging**: PHP built-in error_log to system_logs table (established pattern)
- **Environment**: App Platform deployment-ready with existing .do/app.yaml

### App Platform Integration
[Source: docs/architecture/tech-stack.md#app-platform-configuration]

**Scheduled Job Configuration** (for future automation):
```yaml
# .do/app.yaml addition for automated parsing
jobs:
  - name: tournament-parser
    source_dir: /
    run_command: php scripts/parser/basic_parser.php
    schedule: "0 2 * * *"  # Daily at 2 AM KST
    instance_count: 1
    instance_size_slug: basic-xxs
    envs:
      - key: OSU_FORUM_CLIENT_ID
        scope: RUN_TIME
        type: SECRET
      - key: OSU_FORUM_CLIENT_SECRET
        scope: RUN_TIME
        type: SECRET
```

### Testing Requirements
[Source: docs/architecture/coding-standards.md#testing-standards]

**Parser Testing Strategy:**
- **Unit Tests**: Test API service methods, duplicate detection, data validation
- **Integration Tests**: Test full parser flow with mock API responses
- **Error Handling Tests**: Verify rate limiting, network failures, invalid API responses
- **Korean Content Tests**: Test Korean character handling and timezone conversion

**Test Files Location:**
- `tests/unit/Services/OsuForumServiceTest.php` - Forum API service unit tests
- `tests/unit/Models/TournamentParserTest.php` - Tournament model parser method tests
- `tests/integration/ParserIntegrationTest.php` - Full parser workflow tests

### Parser Implementation Notes

**Critical Implementation Details:**
- **Topic ID Uniqueness**: The `topic_id` field has UNIQUE constraint - use this for duplicate checking
- **Raw Data Storage**: Store minimal processed data - full parsing happens in Story 1.4
- **Status Workflow**: New entries must be `pending_review` status for admin review in Story 1.5
- **Error Recovery**: Parser must be fault-tolerant and continue processing after individual topic failures
- **Rate Limiting**: Implement proper delays between API requests to respect 300/min limit

**Environment Variables Required:**
```bash
# Add to .env.example
OSU_FORUM_CLIENT_ID=your_client_id_here
OSU_FORUM_CLIENT_SECRET=your_client_secret_here
OSU_FORUM_API_BASE=https://osu.ppy.sh/api/v2
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story creation with forum API integration requirements | Scrum Master |
| 2025-09-05 | 1.1 | Security fixes: Enhanced OAuth memory management, rate limiting backoff, auth failure recovery | Product Owner |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Quality Gate: APPROVED ✅

**Date**: 2025-09-05  
**Reviewer**: Quinn (Test Architect) | **Updated by**: Sarah (Product Owner)  
**Risk Score**: 28/100 (Low-Medium Risk) ⬇️ _Improved from 46/100_

#### Gate Decision Rationale

**STORY APPROVED FOR IMPLEMENTATION** - All critical security concerns have been addressed in story documentation v1.1. Enhanced security implementation patterns now provide comprehensive guidance for secure OAuth handling, rate limiting with backoff, and authentication failure recovery.

#### ✅ **RESOLVED Issues** (Previously Critical)

1. **SEC-001 ✅ RESOLVED**: OAuth secure memory management 
   - **Resolution**: Added `sodium_memzero()` implementation with immediate credential clearing
   - **Result**: Prevents credential exposure in logs or memory dumps

2. **SEC-002 ✅ RESOLVED**: API rate limiting with exponential backoff
   - **Resolution**: Conservative 250ms delays with 2s/4s/8s backoff progression  
   - **Result**: Prevents API access suspension from rate limit violations

3. **TECH-001 ✅ RESOLVED**: OAuth authentication failure recovery
   - **Resolution**: Multi-retry logic with timeout and comprehensive error handling
   - **Result**: Ensures parser resilience during authentication failures

#### Assessment Summary

- **Total Risks**: 6 (0 High, 4 Medium, 2 Low) ⬇️ _3 High risks resolved_
- **Test Coverage**: 24 scenarios covering all acceptance criteria ✅
- **Security Focus**: All critical OAuth vulnerabilities resolved ✅
- **Korean Localization**: UTF-8 handling validated in test design ✅

#### Files Referenced

- **Risk Assessment**: `docs/qa/assessments/1.3-risk-20250905.md`
- **Test Design**: `docs/qa/assessments/1.3-test-design-20250905.md`
- **Quality Gate**: `docs/qa/gates/1.3-basic-parser-script.yml`

#### Deployment Readiness

**Status**: ✅ **READY FOR IMPLEMENTATION** - Security requirements satisfied

**Implementation Note**: Follow enhanced security patterns in Dev Notes v1.1 for production-ready OAuth and rate limiting implementation.