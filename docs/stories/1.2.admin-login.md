# Story 1.2: Admin Login

## Status
Draft

## Story
**As a** Site Administrator,
**I want** To log in to the application securely using my osu! account,
**so that** I can access protected admin-only areas.

## Acceptance Criteria
1. An admin-only login page exists.
2. The page has a "Login with osu!" button that initiates the osu! OAuth 2.0 flow.
3. Upon successful authentication, a server-side session is created for the user.
4. The application checks the authenticated user's osu! ID against a hard-coded list of authorized admins.

## Tasks / Subtasks

- [ ] Create OAuth Configuration (AC: 2)
  - [ ] Create `src/config/OAuth.php` with osu! OAuth 2.0 settings
  - [ ] Add OAuth client ID/secret environment variables to `.env.example`
  - [ ] Configure redirect URI for callback handling

- [ ] Implement Authentication Service (AC: 2, 3)
  - [ ] Create `src/services/AuthService.php` for osu! OAuth integration
  - [ ] Implement OAuth authorization URL generation with state parameter
  - [ ] Implement OAuth state parameter generation and validation for CSRF protection
  - [ ] Implement OAuth callback token exchange with state validation
  - [ ] Implement secure OAuth token handling (memory clearing, no logging)
  - [ ] Implement user info retrieval from osu! API

- [ ] Create Admin User Model (AC: 4)
  - [ ] Create `src/models/AdminUser.php` with user management methods
  - [ ] Implement hard-coded admin list validation
  - [ ] Add session management for authenticated users

- [ ] Build Admin Login Interface (AC: 1, 2)
  - [ ] Create `public/admin/login.php` with login form
  - [ ] Create admin layout template `src/templates/layouts/admin.php`
  - [ ] Add "Login with osu!" button with OAuth flow initiation
  - [ ] Style login page with Pico.css consistency

- [ ] Implement OAuth Callback Handler (AC: 3, 4)
  - [ ] Create `public/api/auth.php` for OAuth callback processing
  - [ ] Handle authorization code exchange for access token
  - [ ] Retrieve user info and validate against admin list
  - [ ] Create secure session with CSRF token

- [ ] Add Session Management (AC: 3)
  - [ ] Configure secure session parameters (HttpOnly, Secure, SameSite flags)
  - [ ] Implement session initialization in admin pages
  - [ ] Create logout functionality in `public/admin/logout.php`
  - [ ] Add session validation middleware for protected admin routes

- [ ] Create Security Utilities (AC: 3, 4)
  - [ ] Update `src/utils/SecurityHelper.php` with CSRF token generation
  - [ ] Add admin authorization checking functions
  - [ ] Implement secure session handling

- [ ] Add Unit Tests for Authentication (Testing)
  - [ ] Create `tests/unit/Services/AuthServiceTest.php`
  - [ ] Create `tests/unit/Models/AdminUserTest.php`
  - [ ] Test OAuth flow, session management, and admin validation
  - [ ] Test OAuth CSRF protection with state parameter validation
  - [ ] Test session security configuration and secure token handling

## Dev Notes

### Previous Story Context
[Source: 1.1.project-database-setup.md#dev-agent-record]

From Story 1.1 implementation:
- ✅ Complete directory structure with `public/admin/` ready for admin interface
- ✅ Sessions table exists with CSRF protection architecture (`sessions` table with `csrf_token` field)
- ✅ Users table ready with `osu_id`, `username`, `is_admin` flag
- ✅ Korean timezone (Asia/Seoul) configuration established
- ✅ PSR-4 autoloading configured in `composer.json`
- ✅ Security-first file structure (src/, data/ protected from web access)

### OAuth Integration Architecture
[Source: docs/architecture-progress.md#external-apis]

**osu! API v2 Integration:**
- **Authentication Method**: OAuth 2.0 with client credentials
- **Rate Limits**: 1000/min for API calls
- **OAuth Endpoints**: 
  - Authorization: `https://osu.ppy.sh/oauth/authorize`
  - Token: `https://osu.ppy.sh/oauth/token`
  - User Info: `https://osu.ppy.sh/api/v2/me`
- **Required Scopes**: `public` scope for user info access
- **Callback URL**: Must match registered application redirect URI

### Database Schema Integration
[Source: docs/architecture-progress.md#database-schema]

**Users Table Structure** (already exists from Story 1.1):
```sql
CREATE TABLE users (
    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
    osu_id INTEGER UNIQUE NOT NULL,
    username TEXT NOT NULL,
    is_admin BOOLEAN DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Sessions Table Structure** (already exists from Story 1.1):
```sql
CREATE TABLE sessions (
    session_id TEXT PRIMARY KEY,
    user_id INTEGER,
    csrf_token TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

### File Location Specifications
[Source: docs/architecture-progress.md#unified-project-structure]

**Authentication Components:**
- **OAuth Config**: `src/config/OAuth.php` - OAuth 2.0 settings and environment variables
- **Auth Service**: `src/services/AuthService.php` - OAuth integration and token management
- **Admin Model**: `src/models/AdminUser.php` - Admin user validation and management
- **Security Utils**: `src/utils/SecurityHelper.php` - CSRF and session security functions
- **Login Page**: `public/admin/login.php` - Admin login interface
- **OAuth Callback**: `public/api/auth.php` - OAuth callback handler
- **Admin Layout**: `src/templates/layouts/admin.php` - Admin interface layout template

### Security Requirements
[Source: docs/architecture/coding-standards.md#security-requirements]

**NON-NEGOTIABLE Security Implementation:**
- **OAuth CSRF Protection**: OAuth state parameter MUST be implemented to prevent authorization code interception attacks
- **CSRF Protection**: All admin forms must include CSRF tokens with `hash_equals()` validation
- **Session Security**: Secure session configuration with `HttpOnly`, `Secure`, `SameSite` flags
- **Input Validation**: All OAuth callback parameters must be validated using `filter_var()`
- **Output Escaping**: All dynamic content must use `htmlspecialchars()` with `ENT_QUOTES`
- **SQL Protection**: All database queries must use prepared statements (PDO)
- **Admin Validation**: Hard-coded admin osu! ID list with strict integer validation
- **Token Security**: OAuth tokens must never be logged and cleared from memory after use

**Example Security Implementation:**
```php
// OAuth State Parameter (AuthService.php)
$state = bin2hex(random_bytes(32));
$_SESSION['oauth_state'] = $state;
$authUrl = 'https://osu.ppy.sh/oauth/authorize?client_id=' . $clientId . '&state=' . $state;

// State validation in callback
if (!hash_equals($_SESSION['oauth_state'], $_GET['state'])) {
    throw new SecurityException('OAuth state mismatch - potential CSRF attack');
}

// CSRF token validation (SecurityHelper.php)
if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
    throw new SecurityException('CSRF token mismatch');
}

// Admin validation (AdminUser.php)  
$osuId = filter_var($_GET['osu_id'], FILTER_VALIDATE_INT);
if (!$osuId) {
    throw new ValidationException('Invalid osu! ID');
}
```

### Korean Deployment Considerations
[Source: docs/architecture/tech-stack.md#korean-localization-stack]

**Korean Market Integration:**
- **Timezone**: All timestamps use `Asia/Seoul` timezone (already configured)
- **Character Encoding**: UTF-8 support for Korean usernames and content
- **Environment**: DigitalOcean App Platform Singapore (SGP1) for optimal Korean latency
- **OAuth Redirect**: Must use production domain for App Platform deployment

### Technology Stack Integration
[Source: docs/architecture/tech-stack.md#planned-technology-stack]

**Implementation Stack:**
- **Backend**: Vanilla PHP 8.1+ with PSR-4 autoloading
- **Session Storage**: PHP built-in file-based sessions (container-managed)
- **OAuth Library**: Native PHP cURL for osu! API integration (no external OAuth library)
- **Frontend**: Pico.css for consistent admin interface styling
- **Database**: Existing SQLite with prepared statements via PDO

### Testing Requirements
[Source: docs/architecture-progress.md#testing-strategy]

**Authentication Testing Strategy:**
- **Unit Tests**: Test OAuth token exchange, admin validation, session management
- **Integration Tests**: Test full OAuth flow from login to authenticated session
- **Security Tests**: Verify CSRF protection, session security, admin authorization
- **Manual Tests**: Cross-browser OAuth flow testing, session persistence validation

**Test Files Location:**
- `tests/unit/Services/AuthServiceTest.php` - OAuth service unit tests
- `tests/unit/Models/AdminUserTest.php` - Admin user model tests
- `tests/integration/AuthIntegrationTest.php` - Full OAuth flow integration tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-05 | 1.0 | Initial story creation with OAuth authentication requirements | Scrum Master |
| 2025-09-05 | 1.1 | Security fixes: Added OAuth state parameter, enhanced session security, secure token handling | Product Owner |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Risk Assessment - 2025-09-05

**Risk Profile**: [docs/qa/assessments/1.2-risk-20250905.md](../qa/assessments/1.2-risk-20250905.md)

**Overall Risk Score**: 35/100 (High Risk - Requires Immediate Attention)

**Risk Summary**:
- **Critical**: 1 risk (OAuth CSRF vulnerability)
- **High**: 7 risks (Session security, token handling, API dependencies)
- **Medium**: 0 risks
- **Low**: 1 risk (Session data exposure)

**Critical Security Issue Identified**:
- **SEC-001**: Missing OAuth state parameter creates CSRF vulnerability in authentication flow
- **Impact**: Authorization code interception attacks possible
- **Required Action**: Implement state parameter validation before deployment

**Quality Gate Decision**: **PASS** ✅
- ✅ Critical OAuth CSRF vulnerability resolved (v1.1 security fixes)
- ✅ Comprehensive security controls specified in implementation tasks
- ✅ All high-priority security risks mitigated through detailed requirements
- ✅ Security testing coverage addresses all identified vulnerabilities

**Security Requirements Now Addressed (v1.1)**:
1. ✅ OAuth state parameter validation specified in AuthService tasks (26, 27, 28)
2. ✅ Secure session configuration mandated in task 50 (HttpOnly, Secure, SameSite)
3. ✅ Secure OAuth token handling required in task 29 (no logging, memory clearing)
4. ✅ Production OAuth validation included in comprehensive security requirements

**Testing Strategy Confirmed**:
- ✅ OAuth CSRF attack simulation covered in test design (1.2-UNIT-011, 1.2-INT-005)
- ✅ Complete OAuth flow security testing designed (24 comprehensive scenarios)
- ✅ Session security and admin authorization boundary testing specified

### Test Design - 2025-09-05

**Test Design Document**: [docs/qa/assessments/1.2-test-design-20250905.md](../qa/assessments/1.2-test-design-20250905.md)

**Test Strategy Overview**:
- **Total scenarios**: 24 tests designed
- **Unit tests**: 9 (38%) - Security logic validation
- **Integration tests**: 9 (38%) - Component interaction testing
- **E2E tests**: 6 (25%) - Complete workflow validation
- **Priority distribution**: P0: 21, P1: 3, P2: 0

**Security-First Testing Approach**:
- Comprehensive OAuth CSRF protection testing (SEC-001 mitigation)
- Complete admin authorization boundary testing
- Session security configuration validation
- External API dependency failure scenarios

**Critical Test Coverage**:
- **OAuth Flow**: State parameter generation, validation, and CSRF attack simulation
- **Session Management**: Secure configuration, timeout handling, cleanup
- **Admin Authorization**: Valid/invalid admin ID testing, boundary enforcement
- **API Integration**: Token exchange, user info retrieval, error handling

**Test Execution Strategy**:
1. **Phase 1**: P0 Unit tests (security logic - fail fast)
2. **Phase 2**: P0 Integration tests (component interaction)
3. **Phase 3**: P0 E2E tests (complete security validation)
4. **Phase 4**: P1 tests (user experience scenarios)

**Quality Requirements**:
- **P0 Tests**: 100% pass rate required before deployment consideration
- **P1 Tests**: 95% pass rate acceptable
- All security-critical scenarios must be validated before proceeding

**Test Environment Requirements**:
- Unit: PHPUnit with mocked dependencies
- Integration: Test database with mock osu! API responses
- E2E: Full application stack with test OAuth application

**Next QA Action**: Story ready for development - implement according to security requirements and execute comprehensive test suite

*Reviewed by: Quinn (Test Architect) - 2025-09-05*