# Story 1.6: Edit & Approve Tournament

## Status
Draft

## Story
**As a** Site Administrator,
**I want** To use an edit form to correct any parsed data and approve the tournament,
**so that** I can ensure data quality before it goes public.

## Acceptance Criteria
1. The "Edit" button opens a form pre-filled with all the data for the selected tournament.
2. Any fields that were parsed as NULL are visually highlighted.
3. The form can be submitted to update the tournament's data in the database.
4. An "Approve" button on the form changes the tournament's status to "approved".
5. The form is protected against CSRF attacks.

## Tasks / Subtasks

- [ ] **Enhance Tournament Edit Form Display** (AC: 1, 2)
  - [ ] Extend `src/templates/admin/edit-tournament.php` to display all tournament fields
  - [ ] Implement NULL field highlighting using CSS classes (`field-null`, `field-missing`)
  - [ ] Add Korean text support for field labels and tournament data display
  - [ ] Ensure proper form structure with all tournament data fields pre-populated
  - [ ] Add responsive design using Pico.css framework for mobile admin access

- [ ] **Implement Form Data Processing** (AC: 3, 4)
  - [ ] Extend `public/admin/edit.php` to handle POST requests for tournament updates
  - [ ] Implement tournament data validation using existing ValidationService patterns
  - [ ] Add "Update Tournament" functionality to save edited data to database
  - [ ] Add "Approve Tournament" functionality to change status to "approved"
  - [ ] Implement proper redirect flow after successful update/approval

- [ ] **Extend Tournament Model with Update Methods** (AC: 3, 4)
  - [ ] Add `update($id, $data)` method to Tournament model for data modification
  - [ ] Add `approve($id)` method to Tournament model for status change to "approved"
  - [ ] Implement validation rules for tournament field updates
  - [ ] Add Korean character validation for title and host fields
  - [ ] Ensure database transactions for data consistency

- [ ] **Enhance CSRF Protection** (AC: 5)
  - [ ] Verify CSRF token generation in edit form template
  - [ ] Implement CSRF validation in POST request handling
  - [ ] Add proper error handling for CSRF validation failures
  - [ ] Ensure CSRF tokens are regenerated after successful form submissions

- [ ] **Create Unit Tests for Edit/Approve Functionality** (Testing)
  - [ ] Create tests for Tournament model update() and approve() methods
  - [ ] Create tests for edit form data validation and processing
  - [ ] Test Korean character handling in form updates
  - [ ] Test CSRF protection and security measures
  - [ ] Test NULL field highlighting and form display logic

## Dev Notes

### Previous Story Context
[Source: docs/stories/1.5.admin-review-ui.md#dev-agent-record]

From Story 1.5 implementation (Done - QA Approved):
- ✅ Edit infrastructure exists: `/admin/edit.php` endpoint and edit template created
- ✅ CSRF token generation and validation established via SecurityHelper
- ✅ Database connection and Tournament model ready for CRUD operations
- ✅ Korean timezone (KST) handling implemented with DateHelper utility
- ✅ Admin authentication and authorization fully functional
- ⚠️ **Critical Bugs Fixed**: Tournament constructor and CSRF validation issues resolved in QA

**Foundation Ready**: Story 1.5 provides the admin interface foundation. Edit form exists but needs enhancement for full tournament editing and approval workflow.

### Database Schema Integration
[Source: docs/architecture/database-schema.md#tournaments-table]

**Tournament Table Structure** (established in Story 1.1, enhanced in 1.4):
```sql
CREATE TABLE tournaments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    topic_id INTEGER UNIQUE NOT NULL,
    title TEXT NOT NULL,
    host TEXT NOT NULL,
    mode TEXT NOT NULL CHECK (mode IN ('Standard', 'Taiko', 'Catch', 'Mania')),
    banner_url TEXT,                    -- May be NULL (requires highlighting)
    rank_range TEXT NOT NULL,
    registration_status TEXT NOT NULL CHECK (registration_status IN ('Open', 'Closed', 'Ongoing')),
    registration_link TEXT,             -- May be NULL (requires highlighting)
    discord_link TEXT,                  -- May be NULL (requires highlighting)
    sheet_link TEXT,                    -- May be NULL (requires highlighting)
    stream_link TEXT,                   -- May be NULL (requires highlighting)
    forum_link TEXT NOT NULL,
    badge_prize BOOLEAN DEFAULT 0,
    start_date TEXT,                    -- May be NULL (requires highlighting)
    end_date TEXT,                      -- May be NULL (requires highlighting)
    created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
    status TEXT NOT NULL DEFAULT 'pending_review',  -- Target: change to 'approved'
    language_detected TEXT NOT NULL DEFAULT 'en',
    parsed_terms_used TEXT             -- JSON array (may be NULL)
);
```

**Update/Approval Operations**:
- **Update Query**: Use prepared statements with all tournament fields
- **Approval Query**: `UPDATE tournaments SET status = 'approved', updated_at = datetime('now', '+9 hours') WHERE id = ?`
- **NULL Field Detection**: Check for NULL values in optional fields for UI highlighting

### Technology Stack Integration
[Source: docs/architecture/tech-stack.md#technology-stack-table]

**Form Processing Technology Requirements**:
- **Backend**: Vanilla PHP 8.1+ with PSR-4 autoloading (established)
- **Frontend Enhancement**: jQuery 3.7+ for form validation and progressive enhancement
- **UI Framework**: Pico.css 2.0+ for form styling and responsive design
- **Security**: CSRF tokens, XSS prevention via htmlspecialchars(), prepared statements
- **Korean Support**: UTF-8 encoding for Korean tournament titles and host names

### Project Structure Integration
[Source: docs/architecture/unified-project-structure.md#directory-structure]

**Tournament Edit Form File Locations**:
- **Edit Endpoint**: `public/admin/edit.php` ✅ EXISTS (enhance for POST handling)
- **Edit Template**: `src/templates/admin/edit-tournament.php` ✅ EXISTS (enhance for full form)
- **Tournament Model**: `src/Models/Tournament.php` (add update/approve methods)
- **Validation Service**: `src/services/ValidationService.php` (use for form validation)
- **Security Helper**: `src/utils/SecurityHelper.php` ✅ EXISTS (CSRF protection)

### Backend Architecture Integration
[Source: docs/architecture/backend-architecture.md#controller-template]

**Tournament Edit Controller Pattern**:
```php
// Edit form processing in public/admin/edit.php
public function handleEditSubmission($tournamentId, $formData) {
    // 1. Validate CSRF token
    SecurityHelper::validateCsrfToken($_POST['csrf_token'], $_SESSION['csrf_token']);
    
    // 2. Validate form data
    $validatedData = ValidationService::validateTournamentUpdate($formData);
    
    // 3. Update tournament data
    $success = Tournament::update($tournamentId, $validatedData);
    
    // 4. Handle approval if requested
    if (isset($_POST['approve']) && $_POST['approve'] === '1') {
        Tournament::approve($tournamentId);
    }
    
    return $success;
}
```

**Tournament Model Extension Pattern**:
```php
// Add to src/Models/Tournament.php
public function update($id, $data) {
    $sql = "UPDATE tournaments SET 
            title = :title, host = :host, mode = :mode,
            banner_url = :banner_url, rank_range = :rank_range,
            registration_status = :registration_status,
            registration_link = :registration_link,
            discord_link = :discord_link, sheet_link = :sheet_link,
            stream_link = :stream_link, badge_prize = :badge_prize,
            start_date = :start_date, end_date = :end_date,
            updated_at = datetime('now', '+9 hours')
            WHERE id = :id";
    return $this->db->execute($sql, array_merge($data, ['id' => $id]));
}

public function approve($id) {
    $sql = "UPDATE tournaments SET 
            status = 'approved', 
            updated_at = datetime('now', '+9 hours')
            WHERE id = :id";
    return $this->db->execute($sql, ['id' => $id]);
}
```

### Frontend Architecture Integration
[Source: docs/architecture/frontend-architecture.md#component-template]

**Edit Form Enhancement Pattern**:
```javascript
// Progressive enhancement for edit form
const TournamentEditForm = {
    init: function(element) {
        this.element = $(element);
        this.highlightNullFields();
        this.bindValidation();
        this.setupKoreanTextHandling();
    },
    
    highlightNullFields: function() {
        this.element.find('input[value=""], textarea:empty, select:not(:selected)')
            .addClass('field-null')
            .closest('.form-group')
            .addClass('field-missing');
    },
    
    setupKoreanTextHandling: function() {
        this.element.find('input[name="title"], input[name="host"]')
            .on('input', function() {
                KoreanUtils.validateInput($(this));
            });
    }
};
```

### Security Requirements Implementation
[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]

**CSRF Protection Implementation**:
```php
// CSRF token generation in edit form
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));

// CSRF validation in form processing
if (!hash_equals($_SESSION['csrf_token'] ?? '', $_POST['csrf_token'] ?? '')) {
    throw new SecurityException('CSRF token mismatch');
}

// XSS prevention in form display
$title = htmlspecialchars($tournament['title'], ENT_QUOTES, 'UTF-8');
$host = htmlspecialchars($tournament['host'], ENT_QUOTES, 'UTF-8');
```

**Input Validation Rules**:
- **Title**: Required, max 200 chars, Korean UTF-8 support
- **Host**: Required, max 100 chars, Korean UTF-8 support  
- **Mode**: Must be one of: Standard, Taiko, Catch, Mania
- **Links**: Optional, valid URL format when present
- **Dates**: Optional, valid ISO 8601 format when present

### Korean Language Support Requirements
[Source: docs/architecture/tech-stack.md#korean-deployment-specifics]

**Korean Form Support Implementation**:
```php
// Korean field validation
function validateKoreanText($text) {
    // Ensure UTF-8 encoding
    if (!mb_check_encoding($text, 'UTF-8')) {
        return false;
    }
    // Korean character range validation
    return preg_match('/^[\x{AC00}-\x{D7AF}\x{1100}-\x{11FF}\x{3130}-\x{318F}\w\s\-\[\]().,!@#$%^&*+={}:;"\'<>?\/|\\\\`~]*$/u', $text);
}

// KST timezone handling for timestamps
$updated_at = datetime('now', '+9 hours'); // Korea Standard Time
```

**Korean UI Labels for Edit Form**:
- Tournament Title → 토너먼트 제목
- Host Name → 주최자명  
- Game Mode → 게임 모드
- Registration Status → 등록 상태
- Update Tournament → 토너먼트 수정
- Approve Tournament → 토너먼트 승인

### Testing Requirements
[Source: docs/architecture/testing-strategy.md#backend-tests]

**Tournament Edit Testing Strategy**:
- **Unit Tests**: `tests/unit/models/TournamentTest.php` - Test update() and approve() methods
- **Form Tests**: `tests/unit/AdminEditFormTest.php` - Test form processing and validation
- **Security Tests**: Verify CSRF protection, XSS prevention, SQL injection prevention
- **Korean Support Tests**: Test Korean character input, validation, and storage
- **Integration Tests**: Complete edit workflow from form display to database update

**Test File Locations**:
- Unit tests: `tests/unit/` directory structure (established in Story 1.4)
- Mock data: Include tournaments with NULL fields and Korean text
- Follow existing PHPUnit patterns from previous stories

### Performance Considerations
[Source: docs/architecture/coding-standards.md#performance-budgets]

**Edit Form Performance Requirements**:
- **Form Load Time**: Edit page must load under 2 seconds with pre-populated data
- **Update Processing**: Tournament update operations under 500ms
- **Korean Text Processing**: Efficient UTF-8 validation and storage
- **Database Transactions**: Use transactions for update operations to ensure data consistency

## Testing
**Testing Requirements** from Architecture:
- **Test Framework**: PHPUnit (established in previous stories)
- **Test File Locations**: 
  - `tests/unit/models/TournamentTest.php` - Tournament model update/approve methods
  - `tests/unit/AdminEditFormTest.php` - Edit form processing and validation
- **Coverage Requirements**: All form processing, validation, and tournament update/approval methods
- **Korean Content Testing**: Form input with Korean text, NULL field highlighting, validation
- **Security Testing**: CSRF protection, XSS prevention, input validation
- **Integration Testing**: Complete edit and approval workflow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-08 | 1.0 | Initial story creation for tournament edit & approval based on Epic 1.6 requirements | Bob (Scrum Master) |