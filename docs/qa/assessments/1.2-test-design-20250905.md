# Test Design: Story 1.2 Admin Login

Date: 2025-09-05
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 9 (38%)
- Integration tests: 9 (38%)
- E2E tests: 6 (25%)
- Priority distribution: P0: 21, P1: 3, P2: 0

**Strategic Focus**: Security-first testing approach with comprehensive coverage of OAuth flow, session management, and admin authorization. Heavy emphasis on P0 tests due to critical security implications.

## Test Scenarios by Acceptance Criteria

### AC1: An admin-only login page exists

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                              |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ |
| 1.2-E2E-001  | E2E         | P0       | Admin login page accessible at URL     | Critical path - page must exist           |
| 1.2-E2E-002  | E2E         | P1       | Login page renders correctly            | User experience validation                 |
| 1.2-INT-001  | Integration | P0       | Admin layout template loads             | Component integration validation           |

### AC2: "Login with osu!" button initiates OAuth 2.0 flow

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                              |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ |
| 1.2-UNIT-001 | Unit        | P0       | OAuth URL generation with state         | Critical security - state parameter       |
| 1.2-UNIT-002 | Unit        | P0       | OAuth URL contains required parameters  | OAuth spec compliance validation           |
| 1.2-UNIT-003 | Unit        | P0       | State parameter cryptographic quality   | Security validation of randomness          |
| 1.2-INT-002  | Integration | P0       | OAuth redirect to osu! API             | External integration validation            |
| 1.2-INT-003  | Integration | P0       | State parameter stored in session      | Session integration validation             |
| 1.2-E2E-003  | E2E         | P0       | Click button redirects to osu!         | End-to-end OAuth initiation              |

### AC3: Server-side session created upon successful authentication

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                              |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ |
| 1.2-UNIT-004 | Unit        | P0       | Session data structure validation       | Pure data validation logic                 |
| 1.2-UNIT-005 | Unit        | P0       | CSRF token generation                   | Security token creation logic              |
| 1.2-UNIT-006 | Unit        | P0       | Session expiry calculation              | Time-based logic validation                |
| 1.2-INT-004  | Integration | P0       | Session persistence to database         | Database integration validation            |
| 1.2-INT-005  | Integration | P0       | Session security configuration          | Secure session setup validation           |
| 1.2-INT-006  | Integration | P0       | OAuth callback token exchange           | External API integration                   |
| 1.2-INT-007  | Integration | P0       | User info retrieval from osu! API      | API integration validation                 |
| 1.2-E2E-004  | E2E         | P0       | Complete OAuth flow creates session     | End-to-end authentication validation      |

### AC4: Admin authorization against hard-coded list

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                              |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ |
| 1.2-UNIT-007 | Unit        | P0       | Admin ID validation (authorized user)   | Pure authorization logic                   |
| 1.2-UNIT-008 | Unit        | P0       | Admin ID validation (unauthorized user) | Security boundary validation               |
| 1.2-UNIT-009 | Unit        | P0       | Invalid osu! ID format handling        | Input validation logic                     |
| 1.2-INT-008  | Integration | P0       | Authorized admin session creation       | Full auth flow integration                 |
| 1.2-INT-009  | Integration | P0       | Unauthorized access rejection           | Security boundary enforcement              |
| 1.2-E2E-005  | E2E         | P0       | Authorized admin accesses admin area    | Complete authorization validation          |
| 1.2-E2E-006  | E2E         | P0       | Unauthorized user blocked from admin    | Security boundary end-to-end testing      |

### Security & Error Scenarios

#### Additional Critical Test Scenarios

| ID           | Level       | Priority | Test                                    | Justification                              |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------------ |
| 1.2-E2E-007  | E2E         | P1       | Session logout and cleanup              | Session management validation              |
| 1.2-E2E-008  | E2E         | P1       | Session timeout handling                | Security timeout validation               |

## Risk Coverage Analysis

**Critical Risk Mitigations**:

- **SEC-001** (OAuth CSRF): Covered by 1.2-UNIT-001, 1.2-UNIT-003, 1.2-INT-003, 1.2-E2E-003
- **SEC-002** (Session Security): Covered by 1.2-INT-005, 1.2-E2E-004
- **SEC-003** (Admin Authorization): Covered by 1.2-UNIT-007, 1.2-UNIT-008, 1.2-INT-008, 1.2-INT-009
- **SEC-004** (Token Security): Covered by 1.2-INT-006, 1.2-INT-007
- **TECH-001** (API Dependency): Covered by 1.2-INT-002, 1.2-INT-006, 1.2-INT-007

## Detailed Test Specifications

### Critical P0 Unit Tests

**1.2-UNIT-001: OAuth URL generation with state**
```php
// Test: AuthService::generateAuthUrl()
// Verify: State parameter included and stored
// Mock: None (pure function)
// Data: Various redirect URIs
```

**1.2-UNIT-007: Admin ID validation (authorized user)**
```php
// Test: AdminUser::isAuthorized($osuId)
// Verify: Returns true for valid admin IDs
// Mock: None (configuration data)
// Data: All hard-coded admin IDs
```

**1.2-UNIT-008: Admin ID validation (unauthorized user)**
```php
// Test: AdminUser::isAuthorized($osuId)
// Verify: Returns false for invalid admin IDs
// Mock: None (configuration data)  
// Data: Random non-admin osu! IDs
```

### Critical P0 Integration Tests

**1.2-INT-006: OAuth callback token exchange**
```php
// Test: AuthService::handleCallback()
// Verify: Authorization code exchanged for tokens
// Mock: osu! API responses
// Environment: Test API endpoints
```

**1.2-INT-008: Authorized admin session creation**
```php
// Test: Complete auth flow for admin user
// Verify: Session created with proper data
// Mock: osu! API, admin ID validation
// Environment: Test database
```

### Critical P0 E2E Tests

**1.2-E2E-003: Click button redirects to osu!**
```php
// Test: Admin login page OAuth initiation
// Verify: Redirect to osu! with proper parameters
// Environment: Full application stack
// Data: Valid OAuth configuration
```

**1.2-E2E-005: Authorized admin accesses admin area**
```php
// Test: Complete admin login journey
// Verify: Admin can access protected areas
// Environment: Full application with OAuth
// Data: Authorized admin test account
```

## Test Environment Requirements

### Unit Test Environment
- PHPUnit framework
- No external dependencies
- In-memory data structures
- Mock objects for external calls

### Integration Test Environment
- Test database (SQLite)
- Mock osu! API responses
- Test session storage
- Container/service integration

### E2E Test Environment
- Full application deployment
- Test osu! OAuth application
- Test database with known state
- Browser automation (Selenium/Playwright)

## Test Data Requirements

### OAuth Test Data
- Valid OAuth client credentials (test app)
- Test authorization codes and access tokens
- Invalid tokens for error testing
- State parameters for CSRF testing

### Admin Test Data
- Authorized admin osu! IDs (test accounts)
- Unauthorized osu! IDs for boundary testing
- Invalid ID formats for validation testing
- Session test data with various states

### API Mock Data
- osu! API user response formats
- Error responses (rate limits, server errors)
- Network timeout scenarios
- Invalid JSON responses

## Recommended Execution Order

### Phase 1: Critical Path Validation (P0 Tests)
1. **Unit Tests First** (Fast Feedback)
   - OAuth URL generation and state handling
   - Admin authorization logic
   - Session data validation
   - Input validation functions

2. **Integration Tests Second** (Component Interaction)
   - OAuth service integration
   - Session management with database
   - API communication handling
   - Security configuration validation

3. **E2E Tests Third** (Complete Flow)
   - Full OAuth authentication flow
   - Admin authorization boundaries
   - Session lifecycle management

### Phase 2: Secondary Validation (P1 Tests)
4. **User Experience Tests**
   - Login page rendering
   - Session timeout handling
   - Logout functionality

## Test Coverage Validation

### Coverage Requirements Met:
- ✅ Every AC has comprehensive test coverage
- ✅ Security risks extensively covered across all levels
- ✅ No duplicate coverage (each test validates different aspects)
- ✅ Critical paths have defense in depth (unit + integration + E2E)
- ✅ Test IDs follow naming convention
- ✅ Priorities aligned with security risk assessment

### Coverage Gaps: None identified

## Success Criteria

**P0 Tests (Must Pass):**
- 100% of P0 tests must pass before deployment consideration
- All security-critical scenarios validated
- OAuth flow completely functional and secure
- Admin authorization properly enforced

**P1 Tests (Should Pass):**
- 95% pass rate acceptable for P1 tests
- User experience scenarios validated
- Session management edge cases covered

## Test Maintenance Considerations

- **OAuth Integration**: Tests may break if osu! API changes
- **Security Tests**: Regular review for new attack vectors
- **Session Tests**: Environment-dependent, may need adaptation
- **Admin List**: Update tests when admin list changes

## Integration with Continuous Testing

**Pre-commit Hooks:**
- Run P0 unit tests (< 30 seconds)
- Static security analysis

**CI Pipeline:**
- Full P0 test suite (< 10 minutes)
- Integration tests with mocked externals
- Security scanning

**Pre-deployment:**
- Complete test suite including E2E
- Security penetration testing
- Performance validation under load