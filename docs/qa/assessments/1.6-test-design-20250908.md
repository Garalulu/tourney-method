# Test Design: Story 1.6

Date: 2025-09-08
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 23
- **Unit tests**: 11 (48%)
- **Integration tests**: 8 (35%)
- **E2E tests**: 4 (17%)
- **Priority distribution**: P0: 8, P1: 9, P2: 5, P3: 1

## Test Scenarios by Acceptance Criteria

### AC1: Edit button opens form pre-filled with tournament data

#### Scenarios

| ID           | Level       | Priority | Test Description                          | Justification                               |
|-------------|-------------|----------|------------------------------------------|---------------------------------------------|
| 1.6-UNIT-001| Unit        | P2       | Validate form data pre-population logic  | Pure data transformation logic              |
| 1.6-INT-001 | Integration | P1       | Edit endpoint loads tournament data       | Database retrieval and template rendering   |
| 1.6-E2E-001 | E2E         | P1       | User clicks edit and sees filled form    | Critical admin user journey                 |

### AC2: NULL fields are visually highlighted

#### Scenarios  

| ID           | Level       | Priority | Test Description                          | Justification                               |
|-------------|-------------|----------|------------------------------------------|---------------------------------------------|
| 1.6-UNIT-002| Unit        | P1       | NULL field detection algorithm           | Complex conditional logic for highlighting  |
| 1.6-UNIT-003| Unit        | P2       | CSS class application for NULL fields    | Template rendering logic                    |
| 1.6-INT-002 | Integration | P1       | Template renders NULL highlighting        | UI component integration                    |
| 1.6-E2E-002 | E2E         | P2       | Visual verification of highlighted fields | User experience validation                  |

### AC3: Form submission updates tournament data

#### Scenarios

| ID           | Level       | Priority | Test Description                          | Justification                               |
|-------------|-------------|----------|------------------------------------------|---------------------------------------------|
| 1.6-UNIT-004| Unit        | P0       | Tournament model update() method          | Critical data persistence logic             |
| 1.6-UNIT-005| Unit        | P0       | Input validation for tournament fields    | Data integrity protection                   |
| 1.6-UNIT-006| Unit        | P0       | Korean text validation logic              | Localization-specific business logic       |
| 1.6-UNIT-007| Unit        | P1       | URL format validation                     | Input validation for optional fields       |
| 1.6-UNIT-008| Unit        | P1       | Date format validation                    | Input validation for date fields           |
| 1.6-INT-003 | Integration | P0       | Form POST processing workflow             | Multi-component data flow                   |
| 1.6-INT-004 | Integration | P0       | Database transaction for updates          | Data consistency across operations          |
| 1.6-INT-005 | Integration | P1       | Error handling for validation failures    | Component interaction for error states     |
| 1.6-E2E-003 | E2E         | P1       | Complete edit form submission             | Critical admin workflow                     |

### AC4: Approve button changes status to "approved"

#### Scenarios

| ID           | Level       | Priority | Test Description                          | Justification                               |
|-------------|-------------|----------|------------------------------------------|---------------------------------------------|
| 1.6-UNIT-009| Unit        | P0       | Tournament model approve() method         | Critical status change logic                |
| 1.6-UNIT-010| Unit        | P1       | Status transition validation              | Business rule validation                    |
| 1.6-INT-006 | Integration | P0       | Approval workflow processing              | Multi-step approval process                 |
| 1.6-E2E-004 | E2E         | P0       | Complete tournament approval flow         | Revenue-critical admin function             |

### AC5: CSRF protection implemented

#### Scenarios

| ID           | Level       | Priority | Test Description                          | Justification                               |
|-------------|-------------|----------|------------------------------------------|---------------------------------------------|
| 1.6-UNIT-011| Unit        | P0       | CSRF token validation logic               | Security-critical logic                     |
| 1.6-INT-007 | Integration | P0       | CSRF token generation and validation      | Security component integration              |
| 1.6-INT-008 | Integration | P0       | CSRF attack prevention                    | Security vulnerability testing              |

### Additional Security & Edge Cases

#### Scenarios

| ID           | Level       | Priority | Test Description                          | Justification                               |
|-------------|-------------|----------|------------------------------------------|---------------------------------------------|
| 1.6-INT-009 | Integration | P1       | XSS prevention in Korean text fields      | Security risk mitigation                    |
| 1.6-INT-010 | Integration | P2       | Form validation with mixed NULL/valid data| Complex data state testing                  |
| 1.6-INT-011 | Integration | P2       | Tournament update rollback on failure     | Data integrity protection                   |
| 1.6-E2E-005 | E2E         | P3       | Mobile responsive form behavior           | Accessibility and usability                 |

## Risk Coverage Analysis

Based on the risk profile (1.6-risk-20250908.md):

### Critical Risk Mitigation (SEC-001: CSRF Bypass)
- **1.6-UNIT-011**: CSRF token validation logic (P0)
- **1.6-INT-007**: CSRF token generation and validation (P0) 
- **1.6-INT-008**: CSRF attack prevention testing (P0)

### High Risk Mitigation (DATA-001: Data Corruption)
- **1.6-UNIT-004**: Tournament model update() method (P0)
- **1.6-UNIT-005**: Input validation for tournament fields (P0)
- **1.6-INT-004**: Database transaction for updates (P0)

### High Risk Mitigation (SEC-002: XSS via Korean Text)
- **1.6-UNIT-006**: Korean text validation logic (P0)
- **1.6-INT-009**: XSS prevention in Korean text fields (P1)

## Test Implementation Guidelines

### Unit Tests (`tests/unit/`)

#### Tournament Model Tests (`tests/unit/models/TournamentTest.php`)

```php
/**
 * 1.6-UNIT-004: Tournament model update() method
 * Critical data persistence logic testing
 */
public function testUpdateTournamentWithValidData()
{
    $tournament = new Tournament($this->db);
    $updateData = [
        'title' => '토너먼트 제목 업데이트',
        'host' => '주최자명',
        'mode' => 'Standard',
        // ... other fields
    ];
    
    $result = $tournament->update(1, $updateData);
    $this->assertTrue($result);
    
    $updated = $tournament->findById(1);
    $this->assertEquals($updateData['title'], $updated['title']);
}

/**
 * 1.6-UNIT-009: Tournament model approve() method  
 * Critical status change logic testing
 */
public function testApproveTournamentChangesStatus()
{
    $tournament = new Tournament($this->db);
    
    $result = $tournament->approve(1);
    $this->assertTrue($result);
    
    $approved = $tournament->findById(1);
    $this->assertEquals('approved', $approved['status']);
}
```

#### Validation Tests (`tests/unit/validation/`)

```php  
/**
 * 1.6-UNIT-005: Input validation for tournament fields
 * Data integrity protection testing
 */
public function testValidateTournamentFields()
{
    $validator = new ValidationService();
    
    // Valid data
    $validData = ['title' => 'Valid Tournament', 'host' => 'Valid Host'];
    $this->assertTrue($validator->validateTournamentUpdate($validData));
    
    // Invalid data
    $invalidData = ['title' => '', 'host' => 'Valid Host'];
    $this->assertFalse($validator->validateTournamentUpdate($invalidData));
}

/**
 * 1.6-UNIT-006: Korean text validation logic
 * Localization-specific business logic testing  
 */
public function testKoreanTextValidation()
{
    $validator = new ValidationService();
    
    // Valid Korean text
    $validKorean = '오스! 토너먼트 2024';
    $this->assertTrue($validator->validateKoreanText($validKorean));
    
    // Korean with special characters (should be valid)
    $koreanWithSymbols = '토너먼트 [BWS] 2024!';
    $this->assertTrue($validator->validateKoreanText($koreanWithSymbols));
    
    // Potential XSS in Korean context
    $xssAttempt = '토너먼트<script>alert("xss")</script>';
    $this->assertFalse($validator->validateKoreanText($xssAttempt));
}
```

#### Security Tests (`tests/unit/security/`)

```php
/**
 * 1.6-UNIT-011: CSRF token validation logic
 * Security-critical logic testing
 */
public function testCsrfTokenValidation()
{
    $security = new SecurityHelper();
    
    // Valid token
    $token = $security->generateCsrfToken();
    $this->assertTrue($security->validateCsrfToken($token, $token));
    
    // Invalid token
    $this->assertFalse($security->validateCsrfToken($token, 'invalid'));
    
    // Empty token
    $this->assertFalse($security->validateCsrfToken('', $token));
}
```

### Integration Tests (`tests/integration/`)

#### Admin Edit Flow Tests (`tests/integration/AdminEditFlowTest.php`)

```php
/**
 * 1.6-INT-003: Form POST processing workflow
 * Multi-component data flow testing
 */
public function testEditFormPostProcessing()
{
    // Simulate authenticated admin session
    $_SESSION['admin_authenticated'] = true;
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    
    $_POST = [
        'csrf_token' => $_SESSION['csrf_token'],
        'tournament_id' => 1,
        'title' => '업데이트된 토너먼트',
        'host' => '새 주최자',
        'mode' => 'Taiko'
    ];
    
    ob_start();
    include __DIR__ . '/../../public/admin/edit.php';
    $output = ob_get_clean();
    
    // Verify tournament was updated
    $tournament = new Tournament($this->db);
    $updated = $tournament->findById(1);
    $this->assertEquals('업데이트된 토너먼트', $updated['title']);
}

/**
 * 1.6-INT-007: CSRF token generation and validation
 * Security component integration testing
 */
public function testCsrfProtectionFlow()
{
    // Test CSRF token rejection
    $_POST = [
        'csrf_token' => 'invalid_token',
        'tournament_id' => 1,
        'title' => 'Malicious Update'
    ];
    
    $this->expectException(SecurityException::class);
    include __DIR__ . '/../../public/admin/edit.php';
}
```

### End-to-End Tests (`tests/e2e/`)

#### Admin Tournament Management (`tests/e2e/AdminTournamentManagementTest.php`)

```php
/**
 * 1.6-E2E-003: Complete edit form submission
 * Critical admin workflow testing
 */
public function testCompleteEditWorkflow()
{
    $this->loginAsAdmin();
    
    // Navigate to tournament list
    $this->visit('/admin/index.php');
    $this->see('토너먼트 관리');
    
    // Click edit on first tournament
    $this->click('.edit-tournament-btn[data-id="1"]');
    $this->seePageIs('/admin/edit.php?id=1');
    
    // Verify form is pre-filled
    $this->seeInField('title', 'Existing Tournament');
    
    // Update tournament data
    $this->type('title', '수정된 토너먼트 제목');
    $this->type('host', '새로운 주최자');
    $this->select('mode', 'Standard');
    
    // Submit form
    $this->press('토너먼트 수정');
    
    // Verify success
    $this->see('토너먼트가 성공적으로 수정되었습니다');
    $this->seeInDatabase('tournaments', [
        'id' => 1,
        'title' => '수정된 토너먼트 제목',
        'host' => '새로운 주최자'
    ]);
}

/**
 * 1.6-E2E-004: Complete tournament approval flow
 * Revenue-critical admin function testing
 */
public function testTournamentApprovalWorkflow()
{
    $this->loginAsAdmin();
    
    // Navigate to pending tournaments
    $this->visit('/admin/index.php');
    $this->click('.edit-tournament-btn[data-id="1"]');
    
    // Verify tournament is pending
    $this->see('status: pending_review');
    
    // Approve tournament
    $this->press('승인');
    
    // Verify approval success
    $this->see('토너먼트가 승인되었습니다');
    $this->seeInDatabase('tournaments', [
        'id' => 1,
        'status' => 'approved'
    ]);
}
```

## Test Data Requirements

### Mock Tournament Data

```php
// Korean tournament with NULL fields
$koreanTournamentWithNulls = [
    'id' => 1,
    'topic_id' => 12345,
    'title' => '오스! 월드컵 2024',
    'host' => '토너먼트 주최자',
    'mode' => 'Standard',
    'banner_url' => null,           // Should be highlighted
    'rank_range' => '#1000-#5000',
    'registration_status' => 'Open',
    'registration_link' => null,    // Should be highlighted
    'discord_link' => 'https://discord.gg/example',
    'sheet_link' => null,          // Should be highlighted
    'stream_link' => null,         // Should be highlighted
    'forum_link' => 'https://osu.ppy.sh/community/forums/topics/12345',
    'badge_prize' => false,
    'start_date' => '2024-12-01',
    'end_date' => null,            // Should be highlighted
    'status' => 'pending_review'
];

// Complete tournament data (no NULLs)
$completeTournament = [
    'id' => 2,
    'topic_id' => 67890,
    'title' => 'Complete Tournament Test',
    'host' => 'Test Host',
    'mode' => 'Taiko',
    'banner_url' => 'https://example.com/banner.png',
    'rank_range' => '#500-#2000',
    'registration_status' => 'Closed',
    'registration_link' => 'https://example.com/register',
    'discord_link' => 'https://discord.gg/test',
    'sheet_link' => 'https://docs.google.com/spreadsheets/test',
    'stream_link' => 'https://twitch.tv/test',
    'forum_link' => 'https://osu.ppy.sh/community/forums/topics/67890',
    'badge_prize' => true,
    'start_date' => '2024-11-15',
    'end_date' => '2024-11-30',
    'status' => 'pending_review'
];
```

## Recommended Execution Order

### Phase 1: Critical Security & Data (P0)
1. **1.6-UNIT-011**: CSRF token validation logic
2. **1.6-UNIT-004**: Tournament model update() method  
3. **1.6-UNIT-005**: Input validation for tournament fields
4. **1.6-UNIT-006**: Korean text validation logic
5. **1.6-UNIT-009**: Tournament model approve() method
6. **1.6-INT-003**: Form POST processing workflow
7. **1.6-INT-004**: Database transaction for updates
8. **1.6-INT-006**: Approval workflow processing
9. **1.6-INT-007**: CSRF token generation and validation
10. **1.6-INT-008**: CSRF attack prevention
11. **1.6-E2E-004**: Complete tournament approval flow

### Phase 2: Core Functionality (P1)
12. **1.6-UNIT-002**: NULL field detection algorithm
13. **1.6-UNIT-007**: URL format validation
14. **1.6-UNIT-008**: Date format validation
15. **1.6-UNIT-010**: Status transition validation
16. **1.6-INT-001**: Edit endpoint loads tournament data
17. **1.6-INT-002**: Template renders NULL highlighting
18. **1.6-INT-005**: Error handling for validation failures
19. **1.6-INT-009**: XSS prevention in Korean text fields
20. **1.6-E2E-001**: User clicks edit and sees filled form
21. **1.6-E2E-003**: Complete edit form submission

### Phase 3: Secondary Features (P2)
22. **1.6-UNIT-001**: Validate form data pre-population logic
23. **1.6-UNIT-003**: CSS class application for NULL fields
24. **1.6-INT-010**: Form validation with mixed NULL/valid data
25. **1.6-INT-011**: Tournament update rollback on failure
26. **1.6-E2E-002**: Visual verification of highlighted fields

### Phase 4: Nice-to-Have (P3)
27. **1.6-E2E-005**: Mobile responsive form behavior

## Test Coverage Goals

| Priority | Target Coverage | Minimum Coverage |
|----------|----------------|------------------|
| P0       | 95%            | 90%              |
| P1       | 85%            | 80%              |
| P2       | 70%            | 60%              |
| P3       | Best effort    | 50%              |

## Test Environment Requirements

- **Unit Tests**: In-memory SQLite database for isolation
- **Integration Tests**: Test database with Korean character support
- **E2E Tests**: Full staging environment with Korean locale support
- **CSRF Testing**: Session management and token handling
- **Korean Text Testing**: UTF-8 encoding validation

## Quality Gates

Before story completion, ensure:

- [ ] All P0 tests pass (100%)
- [ ] All P1 tests pass (100%)  
- [ ] P2 test coverage ≥ 60%
- [ ] No critical security vulnerabilities
- [ ] Korean text handling verified
- [ ] CSRF protection confirmed
- [ ] Database transaction integrity validated