# Test Design: Story 1.5

Date: 2025-09-08
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 23
- **Unit tests**: 9 (39%)
- **Integration tests**: 10 (43%)
- **E2E tests**: 4 (18%)
- **Priority distribution**: P0: 8, P1: 10, P2: 4, P3: 1

## Test Scenarios by Acceptance Criteria

### AC1: Protected admin page displays table of tournaments with "pending_review" status

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.5-UNIT-001 | Unit        | P0       | Tournament.findPendingReview() logic   | Core data filtering logic            |
| 1.5-UNIT-002 | Unit        | P0       | Admin authentication check             | Security-critical logic              |
| 1.5-UNIT-003 | Unit        | P1       | Tournament status validation           | Data integrity verification          |
| 1.5-INT-001  | Integration | P0       | Admin auth + DB query integration     | Multi-component security flow        |
| 1.5-INT-002  | Integration | P1       | Database query with Korean titles      | UTF-8 data handling integration      |
| 1.5-INT-003  | Integration | P1       | CSRF token generation and validation   | Security middleware integration      |
| 1.5-E2E-001  | E2E         | P0       | Admin login to dashboard access        | Critical authentication journey      |

**Risk Coverage**: Addresses SEC-001 (admin auth), PERF-001 (query performance), DATA-001 (Korean encoding)

### AC2: Table shows Tournament Title and parse date

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.5-UNIT-004 | Unit        | P1       | KST timezone conversion accuracy       | Date formatting logic                |
| 1.5-UNIT-005 | Unit        | P1       | Korean title HTML escaping             | XSS prevention logic                 |
| 1.5-UNIT-006 | Unit        | P2       | Mixed Korean/English title handling    | Text processing edge cases           |
| 1.5-INT-004  | Integration | P1       | Database to template data pipeline     | Full data rendering flow             |
| 1.5-INT-005  | Integration | P1       | Pico.css table rendering               | UI component integration             |
| 1.5-E2E-002  | E2E         | P1       | Table displays Korean tournament data  | Complete user-visible validation     |

**Risk Coverage**: Addresses SEC-002 (XSS via Korean titles), DATA-001 (encoding), DATA-002 (timezone)

### AC3: Each row has "Edit" button linking to edit page

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.5-UNIT-007 | Unit        | P1       | Edit URL generation with tournament ID | URL construction logic               |
| 1.5-UNIT-008 | Unit        | P0       | CSRF token inclusion in edit links    | Security token generation            |
| 1.5-UNIT-009 | Unit        | P1       | Tournament ID parameter validation     | Input sanitization logic             |
| 1.5-INT-006  | Integration | P1       | Edit button click navigation          | Frontend-backend navigation flow     |
| 1.5-INT-007  | Integration | P2       | Responsive table on mobile devices    | UI responsiveness integration        |
| 1.5-E2E-003  | E2E         | P1       | Edit button navigates to correct page | Complete user workflow               |
| 1.5-E2E-004  | E2E         | P2       | Edit navigation with Korean titles     | Full workflow with complex data      |

**Risk Coverage**: Addresses SEC-003 (CSRF implementation), BUS-001 (mobile usability)

## Cross-Cutting Test Scenarios

### Security & Performance

| ID           | Level       | Priority | Test                                    | Justification                        |
| ------------ | ----------- | -------- | --------------------------------------- | ------------------------------------ |
| 1.5-INT-008  | Integration | P0       | Session timeout and re-authentication | Security boundary testing            |
| 1.5-INT-009  | Integration | P0       | Query performance with 1000+ records  | Performance under load               |
| 1.5-INT-010  | Integration | P1       | XSS prevention with Korean payloads   | Security validation with real data   |

**Risk Coverage**: Addresses SEC-001 (auth), SEC-004 (session), PERF-001 (query performance), SEC-002 (XSS)

## Risk Coverage Matrix

| Risk ID  | Description                     | Test Scenarios                      | Coverage Level |
| -------- | ------------------------------- | ----------------------------------- | -------------- |
| SEC-001  | Admin authentication bypass     | 1.5-UNIT-002, 1.5-INT-001, 1.5-E2E-001, 1.5-INT-008 | Comprehensive |
| SEC-002  | XSS via Korean tournament titles| 1.5-UNIT-005, 1.5-INT-010, 1.5-E2E-002 | High |
| SEC-003  | CSRF token implementation gaps | 1.5-UNIT-008, 1.5-INT-003, 1.5-INT-006 | High |
| PERF-001 | Unbounded tournament list query | 1.5-UNIT-001, 1.5-INT-009         | Medium |
| DATA-001 | Korean character encoding issues| 1.5-UNIT-006, 1.5-INT-002, 1.5-E2E-002 | High |
| DATA-002 | Timezone conversion errors      | 1.5-UNIT-004                       | Low |
| SEC-004  | Session hijacking vulnerability | 1.5-INT-008                        | Low |
| BUS-001  | Admin UI usability on mobile   | 1.5-INT-007, 1.5-E2E-004          | Medium |

## Detailed Test Scenarios

### P0 Critical Tests (Must Execute)

#### 1.5-UNIT-001: Tournament.findPendingReview() Logic
**Test**: Validate that `findPendingReview()` method correctly filters tournaments by status
**Setup**: Create tournaments with various statuses (pending_review, approved, rejected)
**Expected**: Only tournaments with status "pending_review" are returned
**Error Cases**: Empty result set, database connection failure
**Performance**: Execute with 1000+ records to verify efficiency

#### 1.5-UNIT-002: Admin Authentication Check
**Test**: Verify admin authentication logic correctly identifies valid/invalid users
**Setup**: Mock session data with various user IDs (admin, non-admin, expired)
**Expected**: Only configured admin user IDs pass authentication
**Error Cases**: Missing session, invalid user ID, expired session
**Security Focus**: Test boundary conditions and bypass attempts

#### 1.5-UNIT-008: CSRF Token Inclusion
**Test**: Verify CSRF tokens are generated and included in edit links
**Setup**: Mock tournament data and session state
**Expected**: Each edit link contains valid, unique CSRF token
**Error Cases**: Missing token, expired token, duplicate tokens
**Security Focus**: Token format and randomness validation

#### 1.5-INT-001: Admin Auth + DB Query Integration
**Test**: Full authentication flow followed by database query
**Setup**: Authenticated admin session with test tournament data
**Expected**: Successful query execution with proper security context
**Error Cases**: Authentication failure blocks query, session timeout during query
**Performance**: Measure end-to-end response time

#### 1.5-INT-008: Session Timeout Re-authentication
**Test**: Verify session timeout handling and forced re-authentication
**Setup**: Simulate session timeout scenarios during admin operations
**Expected**: User redirected to login, session properly invalidated
**Error Cases**: Session persistence after timeout, authentication bypass
**Security Focus**: Complete session lifecycle validation

#### 1.5-INT-009: Query Performance with Large Dataset
**Test**: Database query performance with realistic data volumes
**Setup**: Database with 1000+ tournaments in pending_review status
**Expected**: Query completes under 500ms, memory usage remains stable
**Error Cases**: Query timeout, memory exhaustion, database lock
**Performance Focus**: Measure query execution time and resource usage

#### 1.5-E2E-001: Admin Login to Dashboard Journey
**Test**: Complete admin authentication and dashboard access workflow
**Setup**: Clean browser state, admin credentials, test tournament data
**Expected**: Successful login, dashboard loads with tournament table
**Error Cases**: Login failure, dashboard access denied, table rendering failure
**User Journey**: Validates complete critical path

### P1 High Priority Tests (Should Execute)

#### 1.5-UNIT-004: KST Timezone Conversion
**Test**: Verify accurate timezone conversion from UTC to KST
**Setup**: Tournament records with various UTC timestamps
**Expected**: All dates display in KST with correct offset (+9 hours)
**Error Cases**: DST handling, leap second handling, invalid timestamps
**Data Focus**: Timezone accuracy across different scenarios

#### 1.5-UNIT-005: Korean Title HTML Escaping
**Test**: Ensure Korean tournament titles are properly escaped for HTML display
**Setup**: Tournament titles containing Korean text and potential XSS payloads
**Expected**: All HTML special characters escaped, Korean text rendered correctly
**Error Cases**: XSS payload execution, character encoding corruption
**Security Focus**: XSS prevention with Korean character sets

#### 1.5-INT-002: Korean Title Database Integration
**Test**: Full pipeline from database storage to template rendering of Korean titles
**Setup**: Tournaments with various Korean title combinations in database
**Expected**: Titles display correctly without encoding issues
**Error Cases**: Character corruption, encoding mismatch, display truncation
**Data Focus**: UTF-8 handling throughout stack

#### 1.5-INT-004: Database to Template Pipeline
**Test**: Complete data flow from database query to HTML template rendering
**Setup**: Mock tournament data with all required fields
**Expected**: All data fields render correctly in admin table
**Error Cases**: Missing data fields, template rendering errors, data type mismatches
**Integration Focus**: Validates complete data presentation layer

#### 1.5-E2E-002: Korean Tournament Table Display
**Test**: End-to-end validation of Korean tournament data display
**Setup**: Browser with Korean font support, tournaments with Korean titles
**Expected**: Table displays Korean text correctly, dates in KST format
**Error Cases**: Font rendering issues, text truncation, layout breaks
**User Experience**: Validates complete Korean content support

### P2 Medium Priority Tests (Nice to Test)

#### 1.5-UNIT-006: Mixed Language Title Processing
**Test**: Handle tournament titles containing both Korean and English text
**Setup**: Tournament titles with mixed character sets and special symbols
**Expected**: Both Korean and English text display correctly
**Error Cases**: Character set conflicts, encoding detection failures
**Edge Case Focus**: Complex text processing scenarios

#### 1.5-INT-007: Mobile Responsive Design
**Test**: Admin table responsiveness on various mobile screen sizes
**Setup**: Mobile browser simulation with different viewport sizes
**Expected**: Table remains usable and readable on mobile devices
**Error Cases**: Horizontal scrolling issues, text truncation, button accessibility
**UI Focus**: Cross-device usability validation

## Recommended Execution Order

### Phase 1: Critical Foundation (P0)
1. **1.5-UNIT-001, 1.5-UNIT-002** - Core logic validation
2. **1.5-INT-001** - Security integration
3. **1.5-E2E-001** - Critical user journey
4. **1.5-INT-008, 1.-INT-009** - Security and performance boundaries

**Gate Decision**: Must pass all P0 tests before proceeding

### Phase 2: Core Functionality (P1)
1. **1.5-UNIT-004, 1.5-UNIT-005** - Data handling logic  
2. **1.5-INT-002, 1.5-INT-004** - Data integration flow
3. **1.5-E2E-002** - Korean content validation
4. **Remaining P1 tests** - Feature completeness

### Phase 3: Polish & Edge Cases (P2+)
1. **P2 tests** - Secondary features and edge cases
2. **P3 tests** - If time permits

## Test Environment Requirements

### Unit Test Environment
- **Framework**: PHPUnit 9.5+
- **Mocking**: PHPUnit mocks for external dependencies
- **Database**: In-memory SQLite for database-dependent tests
- **Korean Support**: UTF-8 locale configuration

### Integration Test Environment  
- **Database**: Test SQLite database with Korean test data
- **Web Server**: PHP built-in server for HTTP testing
- **Session Storage**: File-based sessions for testing
- **Security**: Test CSRF token generation and validation

### E2E Test Environment
- **Browser**: Chrome with Korean font support
- **Test Data**: Comprehensive dataset with Korean tournaments
- **Authentication**: Test admin account configuration
- **Monitoring**: Performance and error monitoring during tests

## Coverage Gaps Analysis

✅ **All Acceptance Criteria Covered**
- AC1: 7 test scenarios across all levels
- AC2: 6 test scenarios focusing on data display
- AC3: 7 test scenarios covering navigation

✅ **All Critical Risks Addressed**
- Security risks covered by dedicated test scenarios
- Performance risks validated under load conditions
- Korean encoding issues tested comprehensively

✅ **Test Level Distribution Appropriate**
- 39% Unit tests for business logic validation
- 43% Integration tests for component interaction
- 18% E2E tests for critical user journeys

## Test Data Requirements

### Korean Tournament Test Data
```sql
-- Korean tournament titles for comprehensive testing
INSERT INTO tournaments (title, tournament_status, created_at) VALUES 
('한국 osu! 토너먼트 2025', 'pending_review', '2025-01-01 10:00:00'),
('Mixed 한글 English Tournament', 'pending_review', '2025-01-02 15:30:00'),
('Special Characters <script>alert("test")</script>', 'pending_review', '2025-01-03 09:15:00');
```

### Admin User Test Configuration  
```php
// Test admin user IDs for authentication testing
$testAdminIds = [999999, 888888]; // Non-production admin IDs
```

## Test Automation Strategy

### Continuous Integration
- **P0 tests**: Execute on every commit
- **P1 tests**: Execute on pull request
- **P2+ tests**: Execute on scheduled builds
- **E2E tests**: Execute on staging deployment

### Performance Monitoring
- Track database query execution times
- Monitor memory usage during large dataset tests
- Alert on test execution time increases

### Korean Content Validation
- Automated Korean font rendering checks
- UTF-8 encoding validation in CI pipeline
- KST timezone accuracy verification

## Test Maintenance Considerations

### High Maintenance (Monitor Closely)
- **E2E tests**: Brittle to UI changes, Korean font dependencies
- **Integration tests**: Database schema sensitivity
- **Security tests**: Authentication configuration changes

### Low Maintenance (Stable)
- **Unit tests**: Pure logic, minimal external dependencies
- **Data validation tests**: Stable business rules
- **Performance benchmarks**: Consistent measurement criteria

## Success Criteria

### Test Completion Gates
- **All P0 tests pass**: Required for any deployment
- **90%+ P1 test pass rate**: Required for production deployment  
- **P2 test execution**: Complete but failures acceptable with mitigation
- **Korean content tests**: 100% pass rate for UTF-8 handling

### Quality Metrics
- **Code coverage**: >80% for admin components
- **Performance benchmarks**: <500ms query execution
- **Security validation**: 100% pass rate for auth and XSS tests
- **Cross-browser compatibility**: Korean text rendering across major browsers