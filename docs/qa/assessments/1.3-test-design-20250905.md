# Test Design: Story 1.3

Date: 2025-09-05
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 12 (50%)
- Integration tests: 9 (37.5%)
- E2E tests: 3 (12.5%)
- Priority distribution: P0: 12, P1: 8, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: A PHP script exists that can be executed

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 1.3-UNIT-001 | Unit        | P1       | Script file permissions check  | Executable script validation     |
| 1.3-UNIT-002 | Unit        | P0       | Environment config loading     | Critical startup dependencies    |
| 1.3-INT-001  | Integration | P0       | Full script execution flow     | End-to-end execution validation  |
| 1.3-E2E-001  | E2E         | P1       | Command line script execution  | Real environment validation      |

### AC2: Script calls osu! API and retrieves topics

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification                      |
| ------------ | ----------- | -------- | --------------------------------- | ---------------------------------- |
| 1.3-UNIT-003 | Unit        | P0       | OAuth token acquisition           | Critical authentication logic      |
| 1.3-UNIT-004 | Unit        | P0       | API request construction          | Request format validation          |
| 1.3-UNIT-005 | Unit        | P0       | API response parsing              | Response data extraction           |
| 1.3-UNIT-006 | Unit        | P0       | Rate limiting implementation      | API abuse prevention              |
| 1.3-UNIT-007 | Unit        | P1       | OAuth token refresh logic        | Token lifecycle management        |
| 1.3-UNIT-008 | Unit        | P0       | API error handling                | Failure resilience                |
| 1.3-INT-002  | Integration | P0       | OAuth authentication flow        | Full auth system validation       |
| 1.3-INT-003  | Integration | P0       | Forum API topics retrieval       | API contract validation           |
| 1.3-INT-004  | Integration | P1       | Rate limit boundary testing      | API limit compliance              |
| 1.3-E2E-002  | E2E         | P0       | Live API integration test        | Real API interaction              |

### AC3: Check topic ID exists before processing

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                    |
| ------------ | ----------- | -------- | ----------------------------------- | -------------------------------- |
| 1.3-UNIT-009 | Unit        | P0       | Topic ID uniqueness validation      | Core duplicate detection logic   |
| 1.3-UNIT-010 | Unit        | P1       | Database query optimization         | Performance validation           |
| 1.3-INT-005  | Integration | P0       | Duplicate detection with database   | Full duplicate checking flow     |
| 1.3-INT-006  | Integration | P0       | Race condition handling             | Concurrent execution safety      |
| 1.3-INT-007  | Integration | P2       | Large dataset duplicate checking    | Performance under load           |

### AC4: Save raw title and post body for new topics

#### Scenarios

| ID           | Level       | Priority | Test                                | Justification                    |
| ------------ | ----------- | -------- | ----------------------------------- | -------------------------------- |
| 1.3-UNIT-011 | Unit        | P1       | Data sanitization logic             | Input validation                 |
| 1.3-UNIT-012 | Unit        | P0       | Korean character encoding           | UTF-8 data integrity            |
| 1.3-INT-008  | Integration | P0       | Database insertion with constraints | Data persistence validation      |
| 1.3-INT-009  | Integration | P1       | Tournament status assignment        | Workflow state management        |
| 1.3-E2E-003  | E2E         | P2       | Complete parsing workflow           | Full system integration          |

## Security & Risk-Based Test Coverage

### High-Risk Scenarios (From Risk Assessment)

| Risk ID  | Test Coverage                       | Test IDs         |
| -------- | ----------------------------------- | ---------------- |
| SEC-001  | OAuth credential security           | 1.3-UNIT-003,INT-002 |
| SEC-002  | Rate limiting implementation        | 1.3-UNIT-006,INT-004 |
| TECH-001 | Authentication failure handling     | 1.3-UNIT-007,008 |
| DATA-001 | Duplicate detection reliability     | 1.3-UNIT-009,INT-005,006 |
| DATA-002 | Korean character encoding           | 1.3-UNIT-012     |

## Detailed Test Scenarios

### Priority 0 Tests (Must Execute)

#### 1.3-UNIT-002: Environment Config Loading
- **Test**: Validate osu! API credentials load from environment
- **Given**: Environment variables OSU_FORUM_CLIENT_ID, OSU_FORUM_CLIENT_SECRET set
- **When**: Script initializes configuration
- **Then**: Credentials are loaded and validated without logging sensitive data
- **Risk Mitigation**: SEC-001 (Credential exposure)

#### 1.3-UNIT-003: OAuth Token Acquisition
- **Test**: Verify OAuth client credentials flow
- **Given**: Valid client credentials
- **When**: Token acquisition requested
- **Then**: Access token obtained and stored securely
- **Risk Mitigation**: TECH-001 (Authentication failure)

#### 1.3-UNIT-006: Rate Limiting Implementation  
- **Test**: Verify API call rate limiting
- **Given**: Rate limit set to 250 requests/minute
- **When**: Multiple rapid API calls made
- **Then**: Calls delayed to maintain rate limit compliance
- **Risk Mitigation**: SEC-002 (Rate limit abuse)

#### 1.3-UNIT-009: Topic ID Uniqueness Validation
- **Test**: Validate duplicate topic detection
- **Given**: Tournament with topic_id 12345 exists in database
- **When**: Parser encounters topic_id 12345 again
- **Then**: Topic is skipped without processing
- **Risk Mitigation**: DATA-001 (Duplicate processing)

#### 1.3-UNIT-012: Korean Character Encoding
- **Test**: Ensure Korean tournament titles preserved
- **Given**: Tournament title contains Korean characters
- **When**: Title processed and stored
- **Then**: Korean characters maintain UTF-8 integrity
- **Risk Mitigation**: DATA-002 (Encoding issues)

#### 1.3-INT-002: OAuth Authentication Flow
- **Test**: Full OAuth integration with API
- **Given**: Valid client credentials configured
- **When**: Authentication flow executed
- **Then**: API access granted and functional
- **Risk Mitigation**: TECH-001 (Authentication failure)

#### 1.3-INT-003: Forum API Topics Retrieval
- **Test**: Retrieve topics from osu! forum API
- **Given**: Authenticated API client
- **When**: Topics list requested from forum endpoint
- **Then**: Topics returned with expected data structure
- **Risk Mitigation**: API contract validation

#### 1.3-INT-005: Duplicate Detection with Database
- **Test**: Database-integrated duplicate checking
- **Given**: Database contains existing tournaments
- **When**: Parser processes topics including duplicates
- **Then**: Only new topics are processed and stored
- **Risk Mitigation**: DATA-001 (Duplicate processing)

#### 1.3-INT-006: Race Condition Handling
- **Test**: Concurrent duplicate checking safety
- **Given**: Multiple parser instances running
- **When**: Same topic processed simultaneously
- **Then**: Database constraints prevent duplicates
- **Risk Mitigation**: DATA-001 (Race conditions)

#### 1.3-INT-008: Database Insertion with Constraints
- **Test**: Tournament data persistence
- **Given**: Valid tournament data from API
- **When**: Data inserted into tournaments table
- **Then**: All required fields stored correctly with proper status
- **Risk Mitigation**: Data integrity validation

#### 1.3-E2E-002: Live API Integration Test
- **Test**: Full parser execution against live API
- **Given**: Production-like environment
- **When**: Parser script executed
- **Then**: New tournaments retrieved and stored successfully
- **Risk Mitigation**: Complete system validation

### Priority 1 Tests (Core Functionality)

#### 1.3-UNIT-007: OAuth Token Refresh Logic
- **Test**: Token lifecycle management
- **Given**: Expired or expiring OAuth token
- **When**: API request made
- **Then**: Token refreshed automatically without service interruption

#### 1.3-UNIT-008: API Error Handling
- **Test**: API failure resilience
- **Given**: API returns error responses (401, 429, 500)
- **When**: Parser encounters errors
- **Then**: Errors handled gracefully with appropriate logging and retry logic

#### 1.3-INT-004: Rate Limit Boundary Testing
- **Test**: Rate limiting edge cases
- **Given**: Rate limit approaching maximum (299/300 requests)
- **When**: Additional requests made
- **Then**: Appropriate delays enforced to prevent limit violation

#### 1.3-INT-009: Tournament Status Assignment
- **Test**: Correct workflow status setting
- **Given**: New tournament data processed
- **When**: Tournament saved to database
- **Then**: Status set to 'pending_review' for admin review workflow

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on critical logic)
   - Environment config, OAuth, rate limiting, duplicate detection, Korean encoding
2. **P0 Integration tests** (core system interactions)
   - Authentication flow, API integration, database operations
3. **P0 E2E test** (complete workflow validation)
   - Live API integration test
4. **P1 tests** (core functionality validation)
   - Token refresh, error handling, boundary testing
5. **P2 tests** (performance and edge cases)
   - Load testing, complete workflow validation

## Test Environment Requirements

### Unit Tests
- PHP 8.1+ with PHPUnit
- Mock objects for API responses
- In-memory database or mocked database layer
- Environment variable mocking

### Integration Tests  
- Test database (SQLite)
- API testing framework or live test endpoints
- OAuth test credentials (sandbox environment)
- Korean character test data

### E2E Tests
- Staging environment with App Platform configuration
- Live osu! API access with test credentials
- Full database instance
- Korean timezone configuration (Asia/Seoul)

## Coverage Requirements

- **Unit Test Coverage**: >90% for core parser logic
- **Integration Coverage**: >80% for API and database interactions
- **E2E Coverage**: All critical user journeys (new topic processing)

## Test Data Requirements

### Korean Content Test Data
```php
// Korean tournament title examples for encoding tests
$koreanTitles = [
    "오스! 토너먼트 2025",
    "한국 스탠다드 대회",
    "Mixed English and 한국어 Title"
];
```

### API Response Mock Data
```json
{
  "data": [
    {
      "id": 12345,
      "title": "Tournament Title",
      "type": "normal",
      "forum_id": 55,
      "created_at": "2025-01-01T12:00:00+00:00"
    }
  ]
}
```